<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev's Face Mesh Core</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* કેમેરા અને કેન્વાસ એકબીજા પર ઓવરલે થશે */
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.4; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* ડેટા પેનલ */
        #debug-panel {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0, 20, 0, 0.8); color: #0f0;
            padding: 10px; border: 1px solid #0f0;
            font-size: 12px; z-index: 100;
            box-shadow: 0 0 10px #0f0;
        }
        
        h3 { margin: 0; border-bottom: 1px solid #0f0; padding-bottom: 5px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="debug-panel">
        <h3>SYSTEM STATUS</h3>
        <p>TRACKING: <span id="status">INITIALIZING...</span></p>
        <p>FACE POINTS: 468 Active</p>
        <p>RIGHT EYE: <span id="eye-r">0.0</span></p>
        <p>LEFT EYE: <span id="eye-l">0.0</span></p>
    </div>

    <div id="container">
        <video id="webcam" playsinline></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('status');
        const eyeRText = document.getElementById('eye-r');
        const eyeLText = document.getElementById('eye-l');

        function onResults(results) {
            // કેન્વાસ સાઈઝ સેટ કરો
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // આપણે ઓરિજિનલ વિડીયો નથી બતાવતા, ફક્ત બ્લેક બેકગ્રાઉન્ડ પર મેશ બતાવીએ તો વધારે સારું લાગશે
            // પણ રેફરન્સ માટે થોડું ટ્રાન્સપરન્ટ વિડીયો રાખ્યું છે CSS માં.

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                statusText.innerText = "LOCKED [ACTIVE]";
                statusText.style.color = "#0f0";

                for (const landmarks of results.multiFaceLandmarks) {
                    
                    // 1. આખા ચહેરાની જાળી (Tesselation) દોરો
                    drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION,
                                   {color: '#C0C0C070', lineWidth: 1});
                    
                    // 2. જમણી આંખ (Right Eye)
                    drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#00FF00', lineWidth: 2});
                    
                    // 3. ડાબી આંખ (Left Eye)
                    drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#00FF00', lineWidth: 2});
                    
                    // 4. હોઠ (Lips)
                    drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS, {color: '#FF0000', lineWidth: 2});

                    // 5. ચહેરો (Face Oval)
                    drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: '#E0E0E0', lineWidth: 1});

                    // --- Advanced Logic: Eye Blink Detection (Simple Math) ---
                    // આંખ ખુલ્લી છે કે બંધ તે ચકાસવા માટે ઉપર અને નીચેના પોપચા વચ્ચેનું અંતર
                    const rightEyeTop = landmarks[159];
                    const rightEyeBottom = landmarks[145];
                    const leftEyeTop = landmarks[386];
                    const leftEyeBottom = landmarks[374];

                    const rDistance = Math.abs(rightEyeTop.y - rightEyeBottom.y);
                    const lDistance = Math.abs(leftEyeTop.y - leftEyeBottom.y);

                    eyeRText.innerText = rDistance.toFixed(4);
                    eyeLText.innerText = lDistance.toFixed(4);

                    // જો વેલ્યુ બહુ ઓછી હોય તો "BLINK" લખવું
                    if(rDistance < 0.01) eyeRText.innerText += " (BLINK)";
                    if(lDistance < 0.01) eyeLText.innerText += " (BLINK)";
                }
            } else {
                statusText.innerText = "SEARCHING...";
                statusText.style.color = "red";
            }
            canvasCtx.restore();
        }

        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true, // આંખ અને હોઠનું સચોટ ટ્રેકિંગ
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        camera.start();
    </script>
</body>
</html>
